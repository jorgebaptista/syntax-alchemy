name: OCaml CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'alchemy-*/**'
      - '.github/workflows/ocaml-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'alchemy-*/**'

jobs:
  detect-projects:
    name: Detect OCaml Projects
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Find OCaml projects
        id: set-matrix
        run: |
          projects=$(find . -maxdepth 2 -name "dune-project" -exec dirname {} \; | sed 's|^\./||' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "matrix=$projects" >> $GITHUB_OUTPUT
          echo "Found projects: $projects"

  build-and-test:
    name: ${{ matrix.project }}
    needs: detect-projects
    if: needs.detect-projects.outputs.matrix != '[]'
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.detect-projects.outputs.matrix) }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up OCaml
        uses: ocaml/setup-ocaml@v2
        with:
          ocaml-compiler: 5.4.x
          dune-cache: true
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc
      
      - name: Install build tools
        run: |
          opam install menhir --yes
      
      - name: Install dependencies
        working-directory: ${{ matrix.project }}
        run: |
          opam install . --deps-only --with-test --yes
      
      - name: Build
        working-directory: ${{ matrix.project }}
        run: |
          opam exec -- dune build
      
      - name: Run tests
        working-directory: ${{ matrix.project }}
        run: |
          opam exec -- dune test
      
      - name: Check formatting
        working-directory: ${{ matrix.project }}
        run: |
          opam install ocamlformat.0.28.1 --yes
          opam exec -- dune build @fmt

  status-check:
    name: Status
    needs: build-and-test
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.build-and-test.result }}" == "success" ]; then
            echo "✅ All projects passed"
          else
            echo "❌ Some projects failed"
            exit 1
          fi
